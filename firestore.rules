rules_version = '2';

// Firestore Database Security Rules
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function isDirectChatParticipant(userId, chatId) {
      return signedIn() && (request.auth.uid == userId || request.auth.uid == chatId);
    }

    function groupMembers() {
      return (resource != null && resource.data != null && resource.data.keys().hasAny(['members']))
        ? resource.data.members
        : ((request.resource != null && request.resource.data.keys().hasAny(['members']))
            ? request.resource.data.members
            : []);
    }

    function isGroupMember() {
      return signedIn() && request.auth.uid in groupMembers();
    }

    // Global app configuration
    match /AppInfo/{docId} {
      allow read: if signedIn();
      allow write: if false; // Sólo administradores via consola
    }

    // Users collection
    match /Users/{userId} {
      // Los usuarios autenticados pueden leer perfiles (para listados/contactos)
      allow read: if signedIn();
      // Cada usuario sólo puede escribir su propio documento
      allow write: if isOwner(userId);

      // User's chats - allow access to both participants
      match /Chats/{chatId} {
        // Function to check if chatId is a valid group
        function isValidGroup() {
          return exists(/databases/$(database)/documents/Groups/$(chatId));
        }
        
        // Function to check if a user is a member of the group (chatId)
        function isMemberOfGroup(checkUserId) {
          return isValidGroup() && 
            checkUserId in get(/databases/$(database)/documents/Groups/$(chatId)).data.members;
        }
        
        // Allow read/write if:
        // 1. User is direct chat participant (1-to-1 chat)
        // 2. User is owner and chatId is klink_ai_assistant
        // 3. chatId is a group AND (the authenticated user is the owner of the chat entry OR is a member of the group)
        //    This allows the admin to create chat entries for other members when creating a group
        allow read, write: if isDirectChatParticipant(userId, chatId) || 
          (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId) ||
          (signedIn() && isValidGroup() && (
            request.auth.uid == userId || // User owns this chat entry
            isMemberOfGroup(request.auth.uid) // User is a member of the group
          ));

        // Messages in chats - allow access to chat participants
        match /Messages/{messageId} {
          // Allow read and create/update for chat participants
          allow read, create, update: if isDirectChatParticipant(userId, chatId) || 
            (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId);
          
          // Allow delete for chat participants (needed for temporary message cleanup)
          // Participants can delete their own messages or messages in their chats
          allow delete: if isDirectChatParticipant(userId, chatId) || 
            (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId);
        }
      }
      
      // Special handling for AI Assistant: allow users to write messages in assistant's chat structure
      match /Users/klink_ai_assistant/Chats/{chatId}/Messages/{messageId} {
        allow read, write: if signedIn() && request.auth.uid == chatId;
      }
      
      match /Users/klink_ai_assistant/Chats/{chatId} {
        allow read, write: if signedIn() && request.auth.uid == chatId;
      }

      // Contacts collection - sólo propietario
      match /Contacts/{contactId} {
        allow read, write: if isOwner(userId);
      }

      // Call history collection - sólo propietario
      match /CallHistory/{callId} {
        allow read, write: if isOwner(userId);
      }

      // Blocked users - users can manage their own blocked list
      match /BlockedUsers/{blockedUserId} {
        allow read: if isOwner(userId) || (signedIn() && request.auth.uid == blockedUserId);
        allow write: if isOwner(userId);
      }
    }
    
    // Groups collection - allow authenticated users to read/write groups they're part of
    match /Groups/{groupId} {
      // Allow creation if user is the creator or will be a member
      allow create: if signedIn() && (
        request.resource.data.createdBy == request.auth.uid ||
        request.auth.uid in request.resource.data.members
      );
      // Allow read/update/delete if user is a member
      allow read, update, delete: if isGroupMember();
      
      // Group messages - allow group members to read/write
      match /Messages/{messageId} {
        // Function to check if user is member of parent group
        function isParentGroupMember() {
          return signedIn() && 
            exists(/databases/$(database)/documents/Groups/$(groupId)) &&
            request.auth.uid in get(/databases/$(database)/documents/Groups/$(groupId)).data.members;
        }
        
        // Allow creation if user is a member of the parent group
        allow create: if isParentGroupMember();
        
        // Allow read and update for group members (check parent group membership)
        allow read, update: if isParentGroupMember();
        
        // Allow delete for group members (needed for temporary message cleanup)
        allow delete: if isParentGroupMember();
      }
    }

    // Stories collection (user stories)
    match /Stories/{storyId} {
      allow read: if signedIn();
      // Solo el propietario puede crear/eliminar historias
      allow create, delete: if signedIn() && request.auth.uid == storyId;
      // Actualizar: 
      // - El propietario puede actualizar cualquier campo
      // - Cualquier usuario autenticado puede actualizar (para marcar como vista con seenBy)
      // Esto es necesario para que los usuarios puedan marcar historias de otros como vistas
      allow update: if signedIn();
    }
    
    // Videos collection (reels/shorts)
    match /Videos/{videoId} {
      // Todos los usuarios autenticados pueden leer videos
      allow read: if signedIn();
      
      // Solo el propietario puede crear sus propios videos
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      
      // Actualizar: 
      // - El propietario puede actualizar cualquier campo
      // - Cualquier usuario autenticado puede actualizar likes, shares, views, comments (usando FieldValue.increment)
      allow update: if signedIn() && (
        // El propietario puede actualizar cualquier campo
        resource.data.userId == request.auth.uid ||
        // Cualquier usuario autenticado puede actualizar (para likes, shares, views, comments)
        // Esto permite usar FieldValue.increment y arrayUnion/arrayRemove
        true
      );
      
      // Solo el propietario puede eliminar sus videos
      allow delete: if signedIn() && resource.data.userId == request.auth.uid;
      
      // Subcolección de comentarios
      match /Comments/{commentId} {
        // Todos los usuarios autenticados pueden leer comentarios
        allow read: if signedIn();
        // Cualquier usuario autenticado puede crear comentarios
        allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
        // Solo el autor del comentario puede actualizarlo o eliminarlo
        allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
      }
    }
    
    // Reports collection - allow authenticated users to create reports
    match /Reports/{reportId} {
      allow create: if signedIn();
      allow read: if false; // Only admins should read reports
    }
    
    // Special case: AI Assistant user document (must be outside Users/{userId} match)
    match /Users/klink_ai_assistant {
      allow read: if signedIn();
      // Permitir crear y actualizar el documento del asistente IA (para inicialización y actualización de estado)
      // Es seguro porque el documento tiene un ID fijo y no contiene información sensible
      allow create, update: if signedIn();
      allow delete: if false; // Nunca permitir eliminar el asistente IA
    }
  }
}